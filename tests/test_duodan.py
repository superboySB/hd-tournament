import numpy as np

# 导弹轨迹数据
missile_positions = np.array([
    [1997.824619488016, -44999.38050601553, 2001.6684355366147],
    [1992.931556817658, -44965.50043691751, 1994.9354707191476],
    [1989.5493494733967, -44952.94406833397, 1993.5472301178468],
    [2007.0610173947703, -44937.17051434948, 2004.8875022417678],
    [1973.399320909558, -44928.333649900735, 1995.1358750214129],
    [1983.2747942138287, -44899.73732905219, 2004.4325659812473],
    [1983.9787360262217, -44882.03369677504, 2004.7157801398278],
    [1981.9351441634012, -44889.3753031123, 1991.3313995653211],
    [1981.9997408311608, -44869.87650260172, 1997.33570508408],
    [1971.8344667534257, -44847.81144187123, 2004.44202219251],
    [1965.3558466688307, -44832.55362055975, 2007.4096272189388],
    [1988.8776355772047, -44812.78606952719, 2006.607706738753],
    [1964.0691886228883, -44789.837246336676, 2012.8275506451762],
    [1959.6062581313342, -44796.18234046078, 2013.054420668247],
    [1957.1553093407754, -44768.90780239075, 2017.1282312538629],
    [1955.0440729636966, -44765.52124931643, 1996.983309757697],
    [1942.6712540701408, -44733.44331701837, 1997.5794927558406],
    [1950.780233535865, -44725.25456811658, 2005.4659525649197],
    [1931.587159332574, -44705.654406314825, 2010.59944892061],
    [1948.5559960401777, -44700.78673876181, 2003.6496793589788],
    [1950.312952597577, -44693.99063802847, 2011.9747707612557],
    [1957.3298830149997, -44661.01626763567, 2026.4237476045264],
    [1936.0577942923983, -44633.733871916746, 1991.3431157374991],
    [1946.3688318501925, -44642.282828765434, 2004.4969346592964],
    [1935.4722823522459, -44625.8059476735, 2000.6288239509893],
    [1931.5828086333952, -44592.66986864413, 2002.6705881035998],
    [1936.1420871791152, -44606.08119223138, 2006.1358717572186],
    [1935.8179218766288, -44576.000004199705, 2003.7959089129806],
    [1931.971929708829, -44553.11319685169, 1997.807030773978],
    [1927.020930783427, -44538.8745694921, 2018.7570262964525],
    [1920.785786188379, -44536.24655064761, 2005.9149093025137],
    [1932.9222030217127, -44483.0765323578, 2001.5097284438548],
    [1913.6785789944317, -44480.45160933454, 2008.300927864407],
    [1929.395300095153, -44500.33434048631, 2009.6874479358771],
    [1927.021736576958, -44483.43533433999, 2023.388632807249],
    [1915.4026791318922, -44453.50273647295, 2003.8242225891],
    [1909.4972410082155, -44432.012526982915, 2007.4897666244938],
    [1914.1039745486817, -44429.03364915405, 1999.0241480838672],
    [1890.278252531951, -44412.82620606723, 1994.1159987350547],
    [1896.7706392963087, -44406.38280613519, 2000.4854279152353],
    [1901.516132445033, -44365.49218681603, 1994.915249746164],
    [1896.087560658451, -44356.316721653355, 1987.6117696867927],
    [1898.0252870408394, -44340.85713222388, 1996.5943705532122],
    [1910.1812396750909, -44331.33857335195, 2010.6986372475537],
    [1879.3317784619928, -44306.120356590174, 2009.8190395712104],
    [1903.3365425214984, -44289.67082887148, 1998.659409752373],
    [1884.484314694431, -44294.712788068886, 1998.0701907803987],
    [1870.506117284095, -44263.81126368586, 2026.4872336949961],
    [1870.4090648186761, -44254.49486798022, 1979.2098671510037],
    [1868.6111608968615, -44234.09592469236, 2000.7235977644725],
])

# 飞机轨迹数据
aircraft_positions = np.array([
    [2000.0246503226213, -24969.251815497835, 2000.0424572532502],
    [2000.0369861209904, -24953.863891850542, 2000.0957152908204],
    [2000.049320807866, -24938.467093789328, 2000.168112072065],
    [2000.061632753361, -24923.061486390812, 2000.2594348805897],
    [2000.073897617686, -24907.647116858025, 2000.3691835856762],
    [2000.086105014473, -24892.223956179172, 2000.4960982238053],
    [2000.0982752986224, -24876.7919321282, 2000.6384459644732],
    [2000.1104732051797, -24861.350958683513, 2000.7943080203677],
    [2000.1228162813634, -24845.900949958635, 2000.9617741690154],
    [2000.1354726985585, -24830.441834960176, 2001.1391605083845],
    [2000.1486491683095, -24814.973564559463, 2001.3251665966418],
    [2000.16257255897, -24799.49615533421, 2001.5189547884665],
    [2000.1774628348949, -24784.009638451, 2001.7202553748957],
    [2000.193504331495, -24768.514011060484, 2001.9294082902134],
    [2000.2108383360983, -24753.009278158108, 2002.1471586435973],
    [2000.229561805445, -24737.49550339977, 2002.3744962081637],
    [2000.2497241400015, -24721.972768572552, 2002.6125840806153],
    [2000.2713712789227, -24706.441163141597, 2002.8623641683935],
    [2000.294609064213, -24690.900748836382, 2003.1241736068514],
    [2000.3196664237298, -24675.351533255944, 2003.3974836730386],
    [2000.3469441832392, -24659.79345498293, 2003.6808021127008],
    [2000.3770024922965, -24644.226411632164, 2003.9719442470068],
    [2000.4105442440018, -24628.650276563487, 2004.2682585163293],
    [2000.4483508724627, -24613.0649316753, 2004.5670331267083],
    [2000.4912132264278, -24597.47032204147, 2004.8658304203418],
    [2000.5398726140816, -24581.8665816918, 2005.1627026225415],
    [2000.5949206180687, -24566.25377318544, 2005.456535952273],
    [2000.6567651903736, -24550.631934758596, 2005.747060443955],
    [2000.7256221665264, -24535.001059693266, 2006.034766173735],
    [2000.801528874301, -24519.361103971583, 2006.3207520525511],
    [2000.8843725538075, -24503.711993358098, 2006.6065480594634],
    [2000.9739573347833, -24488.05366383659, 2006.8938393250792],
    [2001.070071643947, -24472.38619896333, 2007.1842286551355],
    [2001.172537075137, -24456.70966040141, 2007.4790960378468],
    [2001.281335848629, -24441.02410642333, 2007.7792474105745],
    [2001.3967073052142, -24425.329554615055, 2008.084701915046],
    [2001.5191709119529, -24409.625980810884, 2008.394702828511],
    [2001.649463301641, -24393.91333792395, 2008.7079504426474],
    [2001.788488171947, -24378.191561967265, 2009.0227738519961],
    [2001.9371847200773, -24362.460595009696, 2009.33748394159],
    [2002.0964320234323, -24346.720486232854, 2009.6505985594385],
    [2002.266936632409, -24330.971356136506, 2009.9610901633378],
    [2002.4491250419396, -24315.213264968555, 2010.2686045132368],
    [2002.6431273175797, -24299.446234131487, 2010.5734543205617],
    [2002.848790756632, -24283.670241360738, 2010.8765513403887],
    [2003.0657185717143, -24267.885224435366, 2011.179291349622],
    [2003.2933539468318, -24252.091095020947, 2011.4833521732653],
    [2003.531092953157, -24236.287872667024, 2011.7904413765127],
    [2003.7783672213461, -24220.475639328193, 2012.1021289489263],
    [2004.0348101162492, -24204.654464483097, 2012.419525092545],
])

# 时间间隔
delta_t = 0.05

# 计算速度向量（方向）
aircraft_directions = (aircraft_positions[1:] - aircraft_positions[:-1]) / delta_t
missile_directions = (missile_positions[1:] - missile_positions[:-1]) / delta_t

# 归一化方向向量
aircraft_directions /= np.linalg.norm(aircraft_directions, axis=1)[:, None]
missile_directions /= np.linalg.norm(missile_directions, axis=1)[:, None]

# 计算相对位置向量
relative_positions = missile_positions[:-1] - aircraft_positions[:-1]

# 计算导弹相对位置的单位方向向量
relative_directions = relative_positions / np.linalg.norm(relative_positions, axis=1)[:, None]

# 计算飞机和导弹的夹角
cos_theta = np.sum(aircraft_directions * relative_directions, axis=1)
facing_missile = cos_theta > 0

# 计算转向后的方向
def rotate_vector(vector, angle):
    """ Rotates a 3D vector by a given angle around the z-axis """
    rotation_matrix = np.array([
        [np.cos(angle), -np.sin(angle), 0],
        [np.sin(angle), np.cos(angle), 0],
        [0, 0, 1]
    ])
    return np.dot(rotation_matrix, vector)

# 判断飞机在导弹轨迹的哪一侧
def is_left_of_line(point, line_start, line_end):
    """ Determine if a point is to the left of a line segment """
    return ((line_end[0] - line_start[0]) * (point[1] - line_start[1]) - 
            (line_end[1] - line_start[1]) * (point[0] - line_start[0])) > 0

# 计算偏转方向
def calculate_turn_direction(aircraft_dir, missile_dir, relative_dir, facing_missile, aircraft_pos, missile_pos):
    left_dir = rotate_vector(aircraft_dir, np.radians(5))
    right_dir = rotate_vector(aircraft_dir, np.radians(-5))
    
    left_cos_theta = np.dot(left_dir, relative_dir)
    right_cos_theta = np.dot(right_dir, relative_dir)
    
    print(facing_missile)

    if facing_missile:
        # 当前面向导弹，选择使夹角最接近180度的方向
        return "left" if left_cos_theta < right_cos_theta else "right"
    else:
        # 当前背对导弹，判断飞机在导弹轨迹的左侧还是右侧
        missile_line_start = missile_positions[-2]
        missile_line_end = missile_positions[-1]
        aircraft_pos_latest = aircraft_positions[-1]
        if is_left_of_line(aircraft_pos_latest, missile_line_start, missile_line_end):
            # 飞机在导弹轨迹的左侧，应该右转以远离
            return "right"
        else:
            # 飞机在导弹轨迹的右侧，应该左转以远离
            return "left"

# 计算最新时间点的最佳转向
latest_index = -2
turn_direction = calculate_turn_direction(
    aircraft_directions[latest_index], 
    missile_directions[latest_index], 
    relative_directions[latest_index], 
    facing_missile[latest_index], 
    aircraft_positions[latest_index], 
    missile_positions[latest_index]
)

print(turn_direction)
